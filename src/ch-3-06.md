# 使用 PHP 转换 MS SQL Server 到 MySQL

参考网页：
+ sdkf
+ hello

## 引言

工作要求是把 ASP.NET 连接的 MS SQL Server 备份到特定 PHP 连接的 MySQL。由于 MS SQL Server 存储的数据类型不完全是 MySQL 需要的，中间需要对数据表结构变换，使用现成的 SQL Server 转换到 MySQL 不符合本人需求。考虑到对 C# 已经不是很熟悉了，而且生成的 `exe` 文件不方便后期修改，也不方便后期调整，采用 PHP 便于保留源码，方便测试，只需要下载一个 PHP 解释器即可。故采用 PHP 方案。

## 一、测试前准备

该测试是在 Windows 7 32bit 下进行的，需要下载以下文件，
+ win7 sp1 安装包，因为 SQL Server 需要安装此文件。
+ SQL Server 2008 R2 Express，这是在微软官网下载的，那里会有多个选项，下载最大的那个安装包即可。
+ vc_redist.2015.x86， 这是 VC14 的安装包，安装 PHP7 需要它。
+ PHP7 安装包。
+ SQL Server 的 PDO 相关软件。

依次安装这些软件，如有不成功请自行百度解决。在安装 PHP7 时，本人是直接复制 xampp 中 *./php* 文件夹下的所有文件的，并对 php.ini 的部分带 xampp 的内容做了修改，不会对下面的过程有影响。SQL Server 2008 R2 在注册用户的时候，最好选择注册混合登录选项。

## 二、导入 MS SQL Server 的数据文件

导入方法如下，从略。可以右击查看数据库内容。

## 三、使用 PHP 读取 MS SQL Server 内容

代码见后面，下面说一下流程。

### 1、协调两台电脑读写记录

主机和虚拟机（从机）之间的沟通关系应当如下（主机简称主，虚拟机简称虚、从）。**注意：最好在口语描述中，把协议的数组给列出来。**

口语描述：
为防止读写冲突，可以从时间上和空间上解决。时间上比如错开一定的时间。空间上考虑梯次更新，一份读一份写，交替更新。整个流程如下，
1、制定沟通协议，采用读取硬盘文件的方式，文件存储数组序列化值。
2、协议实施过程，从写的角度。首先检测从机读取该信息的有效时间以及读取的文件版本。如果读取信息的时间没有或者滞后于信息上次备份的时间，则必定需要更新，更新的内容还得检测本次的信息更新情况。如果读取信息的时间就是上次更新的时间，查看上次读取的数据和这次更新的数据是否有区别，如果无区别，则只更新信息此次查询的时间，接着告诉从机不需要更新。否则告诉从机需要更新，以及需要读取的信息内容。
3、协议实施过程，从读的角度。检测是否需要更新，决定是否处理这些数据；更新数据的内容取决于协议中提供的版本信息。不管是否更新，都把读取的信息更新时间复制到信息读时间。
4、协议初始缺少文件的一律视为没有读取时间或者与本次不同。
5、如需详情，请看下方代码描述。

代码描述：

下面这段代码是在 Windows 下如何调用备份脚本的。

```bat
/path/to/php.exe /path/to/backup_mssql.php day
```

```bat
/path/to/php.exe /path/to/backup_mssql.php hour
```
**解释：**
+ */path/to* 表示到 *php.exe* 或 *backup_mssql.php* 的文件夹路径；
+ `day`,`hour` 用于区分是执行每天一次的命令还是每小时一次的命令。


```php
// 主机的 PHP 代码

```

```php
// 从机的 PHP 代码

```

### 2、胜多负少


